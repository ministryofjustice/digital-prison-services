{% extends "../partials/layout.njk" %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "../macros/alertFlags.njk" import alertFlags %}
{%- from "moj/components/pagination/macro.njk" import mojPagination -%}

{% set title = 'Prisoner search results' %}

{% block content %}
  <h1 class="govuk-heading-l">
    {{title}}
  </h1>

  {% include './partials/prisonerSearchForm.njk' %}

  {% if hasSearched and not errors.length %}
    {% set rows = [] %}
    {% for prisoner in results %}
      {% set prisonerImage = '<img src="/app/images/' + prisoner.offenderNo + '/data" alt="Image of ' + prisoner.name + '" class="prisoner-search__results__image" />' %}
      {% set prisonerLink = '<a href="/prisoner/' + prisoner.offenderNo + '" class="govuk-link">' + prisoner.name + '</a>'%}
      {% set rows = (rows.push([
        { html: prisonerImage },
        { 
          html: prisonerLink,
          attributes: {
            "data-sort-value": prisoner.name
          }
        },
        { text: prisoner.offenderNo },
        { text: prisoner.assignedLivingUnitDesc },
        { text: prisoner.iepLevel },
        { text: prisoner.age },
        { html: alertFlags(prisoner.alerts) }
      ]), rows) %}
    {% endfor %}

    {% if results.length %}
      {{ mojPagination(pagination) }}

      <div class="prisoner-search__results">
        {{ govukTable({
          head: [
            { html: '<span class="govuk-visually-hidden">Picture</span>' },
            { 
              text: "Name",
              attributes: {
                "aria-sort": "ascending"
              }
            },
            { text: "Prison number" },
            { 
              text: "Location",
              attributes: {
                "aria-sort": "ascending"
              }
            },
            { 
              text: "Incentive level",
              attributes: {
                "aria-sort": "ascending"
              }
            },
            { 
              text: "Age",
              attributes: {
                "aria-sort": "ascending"
              }
            },
            { text: "Relavent alerts" }
          ],
          rows: rows,
          attributes: { "data-qa": "prisoner-search-results-table" }
        }) }}
      </div>
      
      {{ mojPagination(pagination) }}
    {% else %}
    <p class="govuk-body">No records found matching search criteria.</p>
    {% endif %}
  {% endif %}
{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script src="/assets/moj/components/sortable-table/sortable-table.js"></script>
  <script>
  new MOJFrontend.SortableTable({
    table: $('table')[0],
  })
  </script>
{% endblock %}
